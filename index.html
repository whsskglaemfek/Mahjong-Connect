<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì‚¬ì²œì„± ê²Œì„ í”„ë¡œí† íƒ€ì… + ì• ë‹ˆë©”ì´ì…˜</title>
    <style>
      :root {
        --tile-size: 50px;
        --gap-size: 4px;
        --bg-color: #2c3e50;
        --tile-color: #ecf0f1;
        --selected-color: #f1c40f;
        --line-color: #e74c3c; /* ì—°ê²°ì„  ìƒ‰ìƒ */
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: var(--bg-color);
        color: white;
        font-family: sans-serif;
      }
      /* ê²Œì„ ì»¨í…Œì´ë„ˆ: ë³´ë“œì™€ ìº”ë²„ìŠ¤ë¥¼ ê²¹ì¹˜ê¸° ìœ„í•¨ */
      .game-container {
        position: relative;
        margin-top: 20px;
        background: #34495e;
        border-radius: 8px;
        padding: 10px;
      }
      #game-board {
        display: grid;
        gap: var(--gap-size);
        /* paddingì€ ì»¨í…Œì´ë„ˆë¡œ ì´ë™ */
      }
      /* ìº”ë²„ìŠ¤: ë³´ë“œ ìœ„ì— ì ˆëŒ€ ìœ„ì¹˜ë¡œ ê²¹ì¹¨ */
      #game-canvas {
        position: absolute;
        top: 10px; /* ì»¨í…Œì´ë„ˆ padding ê³ ë ¤ */
        left: 10px;
        pointer-events: none; /* ë§ˆìš°ìŠ¤ í´ë¦­ì´ í†µê³¼ë˜ë„ë¡ ì„¤ì • */
        z-index: 10; /* ë³´ë“œë³´ë‹¤ ìœ„ì— í‘œì‹œ */
      }
      .tile {
        width: var(--tile-size);
        height: var(--tile-size);
        background-color: var(--tile-color);
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        user-select: none;
        box-sizing: border-box; /* í…Œë‘ë¦¬ í¬í•¨ í¬ê¸° ê³„ì‚° */
      }
      .tile.empty {
        visibility: hidden;
      }
      .tile.selected {
        border: 4px solid var(--selected-color);
        /* transform ì œê±°: ì¢Œí‘œ ê³„ì‚° ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ */
      }
      .controls {
        margin-top: 20px;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        background: #27ae60;
        color: white;
        border: none;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>ì‚¬ì²œì„± í”„ë¡œí† íƒ€ì… (ì„  ì—°ê²°)</h1>

    <div class="game-container">
      <canvas id="game-canvas"></canvas>
      <div id="game-board"></div>
    </div>

    <div class="controls">
      <button onclick="initGame()">ê²Œì„ ì¬ì‹œì‘</button>
      <p>ê·œì¹™: 2ë²ˆ ì´í•˜ë¡œ êº¾ì´ëŠ” ê²½ë¡œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <script>
      const ROWS = 8;
      const COLS = 10;
      const TILE_SIZE = 50;
      const GAP_SIZE = 4;
      const EMOJIS = [
        "ğŸ",
        "ğŸ",
        "ğŸŠ",
        "ğŸ‹",
        "ğŸŒ",
        "ğŸ‰",
        "ğŸ‡",
        "ğŸ“",
        "ğŸ’",
        "ğŸ¥‘",
      ];

      let board = [];
      let firstSelected = null;
      let isAnimating = false; // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ í´ë¦­ ë°©ì§€
      const canvas = document.getElementById("game-canvas");
      const ctx = canvas.getContext("2d");

      function initGame() {
        const boardElement = document.getElementById("game-board");
        boardElement.style.gridTemplateColumns = `repeat(${COLS}, var(--tile-size))`;
        boardElement.innerHTML = "";
        board = [];
        firstSelected = null;
        isAnimating = false;
        clearCanvas();

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ë³´ë“œ ì „ì²´ í¬ê¸°ì— ë§ì¶¤)
        const totalWidth = COLS * TILE_SIZE + (COLS - 1) * GAP_SIZE;
        const totalHeight = ROWS * TILE_SIZE + (ROWS - 1) * GAP_SIZE;
        canvas.width = totalWidth;
        canvas.height = totalHeight;

        let items = [];
        for (let i = 0; i < ((ROWS - 2) * (COLS - 2)) / 2; i++) {
          const emoji = EMOJIS[i % EMOJIS.length];
          items.push(emoji, emoji);
        }
        items.sort(() => Math.random() - 0.5);

        let idx = 0;
        for (let r = 0; r < ROWS; r++) {
          board[r] = [];
          for (let c = 0; c < COLS; c++) {
            if (r === 0 || r === ROWS - 1 || c === 0 || c === COLS - 1) {
              board[r][c] = null;
            } else {
              board[r][c] = items[idx++];
            }
            renderTile(r, c);
          }
        }
      }

      function renderTile(r, c) {
        const boardElement = document.getElementById("game-board");
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.id = `tile-${r}-${c}`; // ID ë¶€ì—¬ (ì„ íƒ í•´ì œ ì‹œ ì‚¬ìš©)

        if (!board[r][c]) {
          tile.classList.add("empty");
        } else {
          tile.textContent = board[r][c];
          tile.onclick = () => onTileClick(r, c, tile);
        }
        boardElement.appendChild(tile);
      }

      function onTileClick(r, c, el) {
        if (isAnimating) return; // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì—ëŠ” í´ë¦­ ë¬´ì‹œ

        if (firstSelected) {
          if (firstSelected.r === r && firstSelected.c === c) {
            // ê°™ì€ê±° ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ ì·¨ì†Œ
            el.classList.remove("selected");
            firstSelected = null;
            return;
          }

          const r1 = firstSelected.r,
            c1 = firstSelected.c;

          // ë‘ ë²ˆì§¸ í´ë¦­í•œ íƒ€ì¼ë„ ì„ íƒ í‘œì‹œ
          el.classList.add("selected");

          // íŒ¨ê°€ ê°™ê³ , ê²½ë¡œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if (board[r1][c1] === board[r][c]) {
            const path = findPath(r1, c1, r, c);
            if (path) {
              // ë§¤ì¹­ ì„±ê³µ ë° ê²½ë¡œ ìˆìŒ -> ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
              isAnimating = true;
              drawPath(path);

              // 0.3ì´ˆ í›„ íƒ€ì¼ ì œê±° ë° ì„  ì§€ìš°ê¸°
              setTimeout(() => {
                board[r1][c1] = null;
                board[r][c] = null;
                clearCanvas();
                refreshBoard();
                isAnimating = false;
                firstSelected = null;
              }, 300); // 300ms ë”œë ˆì´
            } else {
              // ë§¤ì¹­ ì‹¤íŒ¨ (ê²½ë¡œ ì—†ìŒ)
              resetSelection(el);
            }
          } else {
            // ë§¤ì¹­ ì‹¤íŒ¨ (ëª¨ì–‘ ë‹¤ë¦„)
            resetSelection(el);
          }
        } else {
          firstSelected = { r, c };
          el.classList.add("selected");
        }
      }

      function resetSelection(currentEl) {
        // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ì„ íƒ í‘œì‹œ í•´ì œ (ì‚¬ìš©ìê°€ ì‹¤íŒ¨ë¥¼ ì¸ì§€í•˜ë„ë¡)
        isAnimating = true;
        setTimeout(() => {
          if (firstSelected) {
            const firstEl = document.getElementById(
              `tile-${firstSelected.r}-${firstSelected.c}`
            );
            if (firstEl) firstEl.classList.remove("selected");
          }
          currentEl.classList.remove("selected");
          firstSelected = null;
          isAnimating = false;
        }, 200);
      }

      // BFS ê²½ë¡œ ì°¾ê¸° (ê²½ë¡œ ë°°ì—´ ë°˜í™˜)
      function findPath(r1, c1, r2, c2) {
        const dr = [-1, 1, 0, 0]; // ìƒí•˜ì¢Œìš°
        const dc = [0, 0, -1, 1];
        // í ìš”ì†Œ: { ì¢Œí‘œr, ì¢Œí‘œc, ì´ì „ë°©í–¥, êº¾ì¸íšŸìˆ˜, ë¶€ëª¨ë…¸ë“œ(ê²½ë¡œì¶”ì ìš©) }
        const queue = [{ r: r1, c: c1, dir: -1, turns: -1, parent: null }];
        // ë°©ë¬¸ ì²´í¬: í•´ë‹¹ ì¢Œí‘œì— ë„ë‹¬í–ˆì„ ë•Œì˜ ìµœì†Œ êº¾ì„ íšŸìˆ˜ë¥¼ ì €ì¥
        const visited = Array.from({ length: ROWS }, () =>
          Array(COLS).fill(Infinity)
        );

        while (queue.length > 0) {
          const curr = queue.shift();

          if (curr.turns > 2) continue;
          if (curr.r === r2 && curr.c === c2) {
            return reconstructPath(curr); // ê²½ë¡œ êµ¬ì„± í›„ ë°˜í™˜
          }

          for (let i = 0; i < 4; i++) {
            const nr = curr.r + dr[i];
            const nc = curr.c + dc[i];
            // ë°©í–¥ì´ ê°™ê±°ë‚˜ ì²˜ìŒ ì‹œì‘ì´ë©´ êº¾ì„ íšŸìˆ˜ ìœ ì§€, ë‹¤ë¥´ë©´ +1
            const nextTurns =
              curr.dir === i || curr.dir === -1 ? curr.turns : curr.turns + 1;

            if (
              nr >= 0 &&
              nr < ROWS &&
              nc >= 0 &&
              nc < COLS &&
              nextTurns <= 2
            ) {
              // ë” ì ê±°ë‚˜ ê°™ì€ êº¾ì„ íšŸìˆ˜ë¡œ ë„ë‹¬í•œ ê²½ìš°ë§Œ ì§„í–‰
              if (visited[nr][nc] >= nextTurns) {
                // ëª©ì ì§€ì´ê±°ë‚˜ ë¹ˆ ê³µê°„ì´ì–´ì•¼ ì´ë™ ê°€ëŠ¥
                if ((nr === r2 && nc === c2) || board[nr][nc] === null) {
                  visited[nr][nc] = nextTurns;
                  queue.push({
                    r: nr,
                    c: nc,
                    dir: i,
                    turns: nextTurns,
                    parent: curr,
                  });
                }
              }
            }
          }
        }
        return null; // ê²½ë¡œ ì—†ìŒ
      }

      // ê²½ë¡œ ì—­ì¶”ì  í•¨ìˆ˜
      function reconstructPath(node) {
        const path = [];
        let curr = node;
        while (curr) {
          path.unshift({ r: curr.r, c: curr.c }); // ë°°ì—´ ì•ì— ì¶”ê°€
          curr = curr.parent;
        }
        return path;
      }

      // ìº”ë²„ìŠ¤ì— ì„  ê·¸ë¦¬ê¸°
      function drawPath(path) {
        if (!path || path.length < 2) return;

        ctx.beginPath();
        ctx.strokeStyle = getComputedStyle(document.documentElement)
          .getPropertyValue("--line-color")
          .trim();
        ctx.lineWidth = 5;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        const startPos = getTileCenter(path[0].r, path[0].c);
        ctx.moveTo(startPos.x, startPos.y);

        for (let i = 1; i < path.length; i++) {
          const pos = getTileCenter(path[i].r, path[i].c);
          ctx.lineTo(pos.x, pos.y);
        }
        ctx.stroke();
      }

      // íƒ€ì¼ì˜ ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚° (ìº”ë²„ìŠ¤ ê¸°ì¤€)
      function getTileCenter(r, c) {
        const x = c * (TILE_SIZE + GAP_SIZE) + TILE_SIZE / 2;
        const y = r * (TILE_SIZE + GAP_SIZE) + TILE_SIZE / 2;
        return { x, y };
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      function refreshBoard() {
        const boardElement = document.getElementById("game-board");
        boardElement.innerHTML = "";
        for (let r = 0; r < ROWS; r++) {
          for (let c = 0; c < COLS; c++) {
            renderTile(r, c);
          }
        }
      }

      initGame();
    </script>
  </body>
</html>
